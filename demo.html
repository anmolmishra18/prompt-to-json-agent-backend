<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt ‚Üí JSON Agent Demo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .panel { border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        textarea { width: 100%; height: 100px; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; white-space: pre-wrap; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        input[type="number"] { width: 60px; }
    </style>
</head>
<body>
    <h1>üöÄ Prompt ‚Üí JSON Agent Demo</h1>
    <p><strong>Backend:</strong> <span id="backend-url">https://prompt-to-json-agent-backend-1.onrender.com</span></p>
    
    <div class="container">
        <div class="panel">
            <h3>1. Generate JSON Spec</h3>
            <textarea id="prompt" placeholder="Enter your prompt here...">design a robot using aluminium; Priority: high</textarea>
            <button onclick="generate()">Generate</button>
            <div id="generate-result" class="result"></div>
        </div>
        
        <div class="panel">
            <h3>2. Evaluate Spec</h3>
            <textarea id="eval-spec" placeholder="JSON spec to evaluate...">{}</textarea>
            <button onclick="evaluate()">Evaluate</button>
            <div id="evaluate-result" class="result"></div>
        </div>
        
        <div class="panel">
            <h3>3. Iterative Improvement</h3>
            <textarea id="iterate-prompt" placeholder="Prompt for iteration...">design a robot using aluminium</textarea>
            <label>Max Iterations: <input type="number" id="max-iters" value="3" min="1" max="10"></label>
            <button onclick="iterate()">Iterate</button>
            <div id="iterate-result" class="result"></div>
        </div>
        
        <div class="panel">
            <h3>4. Log HIDG Values</h3>
            <input type="text" id="honesty" placeholder="Honesty reflection..." style="width: 100%; margin: 5px 0;">
            <input type="text" id="integrity" placeholder="Integrity reflection..." style="width: 100%; margin: 5px 0;">
            <input type="text" id="discipline" placeholder="Discipline reflection..." style="width: 100%; margin: 5px 0;">
            <input type="text" id="gratitude" placeholder="Gratitude reflection..." style="width: 100%; margin: 5px 0;">
            <button onclick="logValues()">Log Values</button>
            <div id="hidg-result" class="result"></div>
        </div>
    </div>
    
    <div class="panel" style="margin-top: 20px;">
        <h3>5. System Status</h3>
        <button onclick="checkHealth()">Check Health</button>
        <button onclick="getHIDGLogs()">Get HIDG Logs</button>
        <button onclick="getAnalytics()">Get Analytics</button>
        <div id="status-result" class="result"></div>
    </div>

    <script>
        // Try production first, fallback to local
        const API_BASE = 'https://prompt-to-json-agent-backend-1.onrender.com';
        let lastReportId = null;
        
        // Test connection on load
        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`, { mode: 'cors' });
                if (response.ok) {
                    console.log('‚úÖ Connected to production API');
                    return true;
                }
            } catch (error) {
                console.log('‚ùå Production API not accessible:', error.message);
            }
            return false;
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                };
                if (body) options.body = JSON.stringify(body);
                
                console.log(`Making ${method} request to ${API_BASE}${endpoint}`);
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { detail: errorText };
                    }
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                return { success: true, data };
            } catch (error) {
                console.error('API call failed:', error);
                return { success: false, error: error.message };
            }
        }

        async function generate() {
            const prompt = document.getElementById('prompt').value;
            const result = await apiCall('/generate', 'POST', { prompt });
            const resultDiv = document.getElementById('generate-result');
            
            if (result.success) {
                lastReportId = result.data.id;
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Generated!\nID: ${result.data.id}\nJSON: ${JSON.stringify(result.data.json_spec, null, 2)}`;
                document.getElementById('eval-spec').value = JSON.stringify(result.data.json_spec, null, 2);
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${result.error}`;
            }
        }

        async function evaluate() {
            const specText = document.getElementById('eval-spec').value;
            try {
                const json_spec = JSON.parse(specText);
                const result = await apiCall('/evaluate', 'POST', { json_spec });
                const resultDiv = document.getElementById('evaluate-result');
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Score: ${result.data.score}\nComments: ${result.data.comments}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Error: ${result.error}`;
                }
            } catch (e) {
                document.getElementById('evaluate-result').className = 'result error';
                document.getElementById('evaluate-result').textContent = '‚ùå Invalid JSON';
            }
        }

        async function iterate() {
            const prompt = document.getElementById('iterate-prompt').value;
            const max_iters = parseInt(document.getElementById('max-iters').value);
            const result = await apiCall('/iterate', 'POST', { prompt, max_iters });
            const resultDiv = document.getElementById('iterate-result');
            
            if (result.success) {
                lastReportId = result.data.report_id;
                resultDiv.className = 'result success';
                let output = `‚úÖ Iterations Complete!\nReport ID: ${result.data.report_id}\n\n`;
                result.data.iterations.forEach(iter => {
                    output += `--- Iteration ${iter.iteration_number} ---\n`;
                    output += `Score: ${iter.score_before} ‚Üí ${iter.score_after}\n`;
                    output += `Feedback: ${iter.feedback}\n\n`;
                });
                resultDiv.textContent = output;
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${result.error}`;
            }
        }

        async function logValues() {
            const hidg = {
                honesty: document.getElementById('honesty').value,
                integrity: document.getElementById('integrity').value,
                discipline: document.getElementById('discipline').value,
                gratitude: document.getElementById('gratitude').value
            };
            
            const result = await apiCall('/log-values', 'POST', hidg);
            const resultDiv = document.getElementById('hidg-result');
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Values logged!\nID: ${result.data.id}`;
                // Clear inputs
                ['honesty', 'integrity', 'discipline', 'gratitude'].forEach(id => {
                    document.getElementById(id).value = '';
                });
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${result.error}`;
            }
        }

        async function checkHealth() {
            const result = await apiCall('/health');
            const resultDiv = document.getElementById('status-result');
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ System Status: ${result.data.status}\nDatabase: ${result.data.database}\nVersion: ${result.data.version}`;
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Health check failed: ${result.error}`;
            }
        }

        async function getHIDGLogs() {
            const result = await apiCall('/hidg-logs?limit=5');
            const resultDiv = document.getElementById('status-result');
            
            if (result.success) {
                resultDiv.className = 'result success';
                let output = `‚úÖ Recent HIDG Logs (${result.data.showing}/${result.data.total_count}):\n\n`;
                result.data.logs.forEach(log => {
                    output += `${log.created_at.split('T')[0]}: ${log.honesty.substring(0, 50)}...\n`;
                });
                resultDiv.textContent = output;
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${result.error}`;
            }
        }

        async function getAnalytics() {
            const result = await apiCall('/hidg-analytics');
            const resultDiv = document.getElementById('status-result');
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ HIDG Analytics:\nTotal Entries: ${result.data.total_entries}\nConsistency Score: ${(result.data.consistency_score * 100).toFixed(1)}%\nAvg Reflection Length: ${Math.round(result.data.average_reflection_length?.honesty || 0)} chars`;
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${result.error}`;
            }
        }

        // Auto-check health on load
        window.onload = async () => {
            await testConnection();
            checkHealth();
        };
    </script>
</body>
</html>